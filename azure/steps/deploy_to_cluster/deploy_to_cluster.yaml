parameters:
  timeoutInMinutes: 5
  tool: helm
  helmVersion: v3.4.2
  helmTimeout: 4m

steps:
  #kubectl is left as fall-back if helm becomes messy to maintain
  - ${{ if eq(parameters.tool,'kubectl') }}:
    - task: ShellScript@2
      displayName: Deploy cluster (kubectl)
      timeoutInMinutes: ${{ parameters.timeoutInMinutes }}
      condition: and(succeeded(), not(eq(variables._crux_deploy_to_cluster, false)))
      inputs:
        scriptPath: $(_crux_steps_path)/deploy_to_cluster/deploy_to_cluster.sh
        args: >
          $(System.DefaultWorkingDirectory)
          $(_crux_cluster_deployment_namespace)
          $(_crux_jmeter_master_service)
          $(_crux_jmeter_slaves_service)
          $(_crux_cluster_jmeter_slaves_replicas)
          $(_crux_jmeter_master_deploy_file)
          $(_crux_jmeter_slave_deploy_file)
          15
          $(_crux_aks_agent_pool)

  #helm is the recommended way to manage the cluster
  - ${{ if eq(parameters.tool,'helm') }}:
      - task: HelmInstaller@1
        timeoutInMinutes: ${{ parameters.timeoutInMinutes }}
        displayName: 'Install Helm'
        inputs:
          helmVersionToInstall: ${{ parameters.helmVersion }}

      - task: HelmDeploy@0
        timeoutInMinutes: ${{ parameters.timeoutInMinutes }}
        displayName: 'helm upgrade'
        inputs:
          azureSubscriptionEndpoint: $(_crux_arm_service_connection)
          azureResourceGroup: $(_crux_cluster_resource_group)
          kubernetesCluster: $(_crux_cluster_name)
          namespace: $(_crux_cluster_deployment_namespace)
          command: upgrade
          chartType: FilePath
          chartPath: kubernetes/helm/charts/jmeter-cluster
          releaseName: release-$(_crux_cluster_deployment_namespace)
          overrideValues: 'slaveReplicas=2,placementRules=best.effort.placement'
          force: true
          arguments: '--timeout ${{ parameters.helmTimeout }} --create-namespace'

      - task: HelmDeploy@0
        timeoutInMinutes: ${{ parameters.timeoutInMinutes }}
        displayName: 'helm delete'
        condition: always()
        inputs:
          azureSubscriptionEndpoint: $(_crux_arm_service_connection)
          azureResourceGroup: $(_crux_cluster_resource_group)
          kubernetesCluster: $(_crux_cluster_name)
          command: delete
          arguments: '-n $(_crux_cluster_deployment_namespace) release-$(_crux_cluster_deployment_namespace)'

      - bash : |
          kubectl delete pods --namespace $(_crux_cluster_deployment_namespace) --all
          kubectl delete svc --namespace $(_crux_cluster_deployment_namespace) --all
          kubectl delete pv --namespace $(_crux_cluster_deployment_namespace) --all
          kubectl delete pvc --namespace $(_crux_cluster_deployment_namespace) --all
        displayName: Dirty cleanup
        timeoutInMinutes: ${{ parameters.timeoutInMinutes }}