parameters:
  timeoutInMinutes: 5
  tool: helm
steps:
  - ${{ if eq(parameters.tool,'helm') }}:
      #helm delete leaves pvc but deleting namespace will help as a work-around
      - task: HelmDeploy@0
        timeoutInMinutes: ${{ parameters.timeoutInMinutes }}
        displayName: 'helm delete'
        condition: always()
        inputs:
          azureSubscriptionEndpoint: $(_crux_arm_service_connection)
          azureResourceGroup: $(_crux_cluster_resource_group)
          kubernetesCluster: $(_crux_cluster_name)
          command: delete
          arguments: '-n $(_crux_cluster_deployment_namespace) release-$(_crux_cluster_deployment_namespace)'

  - task: ShellScript@2
    displayName: Delete namespace
    timeoutInMinutes: ${{ parameters.timeoutInMinutes }}
    condition: and(always(), not(eq(variables._crux_delete_namespace, false)))
    inputs:
      scriptPath: $(_crux_steps_path)/delete_namespace/delete_namespace.sh
      args: $(_crux_cluster_deployment_namespace)

  - ${{ if eq(parameters.tool,'helm') }}:
      #helm delete leaves pvc but deleting namespace will help as a work-around
      - bash: |
          pv=$(kubectl get pv --namespace $(_crux_cluster_deployment_namespace) -o=jsonpath='{.items[0].metadata.name}')
          kubectl delete --namespace $(_crux_cluster_deployment_namespace) "pv/$pv"
        displayName: Delete PV